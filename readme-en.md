# Project Overview

`xiaomi_plugin_power` is a Python service designed to monitor power consumption from Xiaomi smart plugs and store the data in InfluxDB. This allows for real-time visualization of power usage using tools like Grafana.

(generated by gemini-cli /init)

## Key Features

*   **Multi-device support:** Can monitor multiple smart plugs simultaneously.
*   **Docker support:** Ready for containerized deployment.
*   **InfluxDB Integration:** Writes data to InfluxDB for time-series storage.

## Architecture

The project consists of a scheduler and a task execution module:

*   **`main.py`**: The entry point. It initializes a `BackgroundScheduler` (from `APScheduler`) to run the data collection task periodically (default: every 5 seconds). It handles platform-specific keep-alive mechanisms (signal pause on Linux, sleep loop on Windows).
*   **`task.py`**: Contains the core logic.
    *   **`read_env()`**: Loads configuration from environment variables.
    *   **`setup_devices()`**: Initializes connections to Xiaomi devices using `python-miio` via IPs and tokens.
    *   **`task()`**: The main function called by the scheduler. It reads power data (property `11, 2`) from each device and writes it to InfluxDB.
    *   **`write_to_influxdb()`**: formats and sends data points to the configured InfluxDB instance.

## Running

### Prerequisites

*   InfluxDB instance
*   Xiaomi Device Token(s) (Obtainable via [Xiaomi-cloud-tokens-extractor](https://github.com/PiotrMachowski/Xiaomi-cloud-tokens-extractor))

### Local Development

1.  **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

2.  **Configuration:**
    Set the required environment variables (see Configuration section below). You can use a `.env` file and load it using `source .env` or similar tools.

3.  **Run:**
    ```bash
    python main.py
    ```

### Docker Deployment

1.  **Build:**
    ```bash
    docker build -t xiaomi_plugin_power .
    ```

2.  **Run:**
    ```bash
    docker run -d \
      --name xiaomi_plugin \
      --network host \
      --env-file .env \
      xiaomi_plugin_power
    ```
    *Note: `--network host` is often required for local device discovery/communication, though direct IP connection might work without it depending on network topology.*

## Configuration

The application is configured entirely via environment variables:

| Variable | Description | Example |
| :--- | :--- | :--- |
| `DEVICE_IPS` | Comma-separated list of device IP addresses | `192.168.1.10,192.168.1.11` |
| `DEVICE_TOKENS` | Comma-separated list of device tokens | `token1,token2` |
| `DEVICE_NAMES` | Comma-separated list of device names (for tagging) | `pc_plug,monitor_plug` |
| `INFLUX_HOST` | InfluxDB Host | `localhost` |
| `INFLUX_PORT` | InfluxDB Port | `8086` |
| `INFLUX_USER` | InfluxDB Username | `admin` |
| `INFLUX_PASS` | InfluxDB Password | `password` |
| `INFLUX_DB` | InfluxDB Database Name | `xiaomi_power` |
| `MEASUREMENT` | InfluxDB Measurement Name (Optional) | `power_consumption` (default) |
| `INTERVAL` | Polling interval in seconds (Optional) | `5` (default) |
| `DEBUG` | Enable debug logging (Optional) | `True` or `False` (default) |
